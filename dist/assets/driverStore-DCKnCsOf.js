import{d as v,l as w,A as d}from"./index-DsrysXVe.js";const m=(a,r)=>{const s=(r.lat-a.lat)*Math.PI/180,i=(r.lng-a.lng)*Math.PI/180,n=a.lat*Math.PI/180,t=r.lat*Math.PI/180,o=Math.sin(s/2)**2+Math.cos(n)*Math.cos(t)*Math.sin(i/2)**2;return 2*6371e3*Math.asin(Math.sqrt(o))};let u=0,l=null;const T=1e3,q=10,I=v()((a,r)=>({me:null,approved:void 0,rejectedReason:void 0,earnings:null,requests:[],socket:null,isConnected:!1,register:async e=>{if(!(await fetch(`${d}/drivers/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw new Error("register_failed");a({me:e}),r().startRealtime()},refreshRequests:async()=>{const{me:e}=r(),s=e!=null&&e.vehicleType?`${d}/drivers/requests?vehicleType=${e.vehicleType}`:`${d}/drivers/requests`,i=await fetch(s),n=await i.json();if(!i.ok||!n.success)throw new Error("requests_failed");const t=Array.isArray(n.data)?n.data:[],o=Array.from(new Map(t.map(c=>[c.id,c])).values());a({requests:o})},updateLocation:async e=>{const{me:s}=r();if(s){a({me:{...s,location:e}});try{const i=Date.now();if(l&&i-u<T&&m(l,e)<q)return;u=i,l=e,await fetch(`${d}/drivers/location`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s.id,location:e})})}catch{}}},accept:async e=>{const{me:s}=r();if(!s)throw new Error("not_registered");if(!(await fetch(`${d}/drivers/accept`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({driverId:s.id,requestId:e})})).ok)throw new Error("accept_failed");a({me:{...s,available:!1}})},setAvailable:async e=>{const{me:s}=r();if(!s)return;if(!(await fetch(`${d}/drivers/status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s.id,available:e})})).ok)throw new Error("status_failed");a({me:{...s,available:e}})},refreshApproval:async()=>{const{me:e}=r();if(e)try{const i=await(await fetch(`${d}/drivers/list?status=approved`)).json(),n=Array.isArray(i.data)&&!!i.data.find(o=>o.id===e.id);let t=!1;if(!n){const c=await(await fetch(`${d}/drivers/list?status=pending`)).json();t=Array.isArray(c.data)&&!!c.data.find(f=>f.id===e.id)}a({approved:n,rejectedReason:n||t?void 0:"unspecified"})}catch{}},fetchEarnings:async()=>{const{me:e}=r();if(!e)return;const s=await fetch(`${d}/drivers/earnings/${e.id}`),i=await s.json();if(!s.ok||!i.success)throw new Error("earnings_failed");a({earnings:i.data})},submitComplaint:async e=>{const{me:s}=r();if(!s)throw new Error("not_registered");if(!(await fetch(`${d}/drivers/complaints`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({driverId:s.id,text:e})})).ok)throw new Error("complaint_failed")},updateProfile:async e=>{const{me:s}=r();if(!s)throw new Error("not_registered");const i=await fetch(`${d}/drivers/profile`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s.id,...e})}),n=await i.json();if(!i.ok||!n.success)throw new Error("profile_update_failed");a({me:{...s,...e}})},startRealtime:()=>{const{socket:e,me:s}=r();e&&(e.off("ride:request"),e.off("ride:taken"),e.off("ride:accepted"),e.off("ride:cancelled"));const i=`http://${window.location.hostname}:3005`,n=e||w(i,{transports:["websocket"],reconnection:!0,reconnectionAttempts:1/0,reconnectionDelay:1e3});e||(n.on("connect",()=>{a({isConnected:!0}),r().refreshRequests()}),n.on("disconnect",()=>{a({isConnected:!1})})),n.on("ride:request",t=>{const{me:o}=r();if(o&&(t==null?void 0:t.vehicleType)===(o==null?void 0:o.vehicleType)){if(t!=null&&t.targetDriverId&&String(t.targetDriverId)!==o.id)return;const{requests:c}=r();if(c.some(p=>p.id===t.id))return;const h=[...c,{id:t.id,customerId:t.customerId,pickup:t.pickup,dropoff:t.dropoff,vehicleType:t.vehicleType}],y=Array.from(new Map(h.map(p=>[p.id,p])).values());a({requests:y})}}),n.on(`driver:${s==null?void 0:s.id}:request`,t=>{if(!t)return;const{requests:o}=r();o.some(f=>f.id===t.id)||a({requests:[...o,{id:t.id,customerId:t.customerId,pickup:t.pickup,dropoff:t.dropoff,vehicleType:t.vehicleType}]})}),n.on(`driver:${s==null?void 0:s.id}:assigned`,t=>{if(!t)return;const{requests:o}=r();a({requests:o.filter(c=>c.id!==t.id)})}),n.on("ride:taken",t=>{const{requests:o}=r();a({requests:o.filter(c=>c.id!==t.requestId)})}),n.on("ride:cancelled",t=>{const{requests:o}=r();a({requests:o.filter(c=>c.id!==t.id)})}),a({socket:n})}}));export{I as u};
