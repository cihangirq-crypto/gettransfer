import{u as G,l as q,a as l,j as r,O as H,B as b}from"./index-DrQlKrd_.js";import{d as J,i as K,r as i}from"./router-2lA1gtRA.js";import{c as U}from"./pricing-D7K4FgUv.js";import{C as W,m as Q}from"./ui-pwCvv38W.js";import"./map-BW_WLVrL.js";const I=(p,c)=>{const f=(c.lat-p.lat)*Math.PI/180,h=(c.lng-p.lng)*Math.PI/180,C=p.lat*Math.PI/180,n=c.lat*Math.PI/180,x=Math.sin(f/2)**2+Math.cos(C)*Math.cos(n)*Math.sin(h/2)**2;return 2*6371e3*Math.asin(Math.sqrt(x))},st=()=>{var N;const p=J(),{bookingId:c}=K(),{currentBooking:u,refreshBookingById:f,setCurrentBooking:h,updateBookingStatus:C}=G(),[n,x]=i.useState(null),[o,$]=i.useState(null),[v,j]=i.useState([]),[w,k]=i.useState([]),[P,B]=i.useState(!1),S=i.useRef(null),T=i.useRef(null),A=i.useRef(!1),z=i.useRef(0),t=i.useMemo(()=>!c||!u?null:u.id===c?u:null,[u,c]);i.useEffect(()=>{c&&f(c).catch(()=>{})},[c,f]),i.useEffect(()=>{const e=`http://${window.location.hostname}:3005`,a=q(e,{transports:["websocket"],reconnection:!0});return S.current=a,a.on("connect",()=>{c&&a.emit("booking:join",{bookingId:c})}),a.on("booking:update",s=>{c&&(s==null?void 0:s.id)===c&&h(s)}),a.on("booking:route",s=>{c&&(s==null?void 0:s.id)===c&&Array.isArray(s==null?void 0:s.driverPath)&&j(s.driverPath)}),a.on("driver:update",s=>{t!=null&&t.driverId&&(s==null?void 0:s.id)===t.driverId&&s!=null&&s.location&&x(s.location)}),()=>{try{c&&a.emit("booking:leave",{bookingId:c})}catch{}a.disconnect(),S.current=null}},[c,t==null?void 0:t.driverId,h]),i.useEffect(()=>{var e;t&&Array.isArray((e=t.route)==null?void 0:e.driverPath)&&t.route.driverPath.length>1&&j(t.route.driverPath)},[(N=t==null?void 0:t.route)==null?void 0:N.driverPath]),i.useEffect(()=>{const e=t;if(!e||!n||e.status==="in_progress"||e.status==="completed"||e.status==="cancelled")return;const a=o||e.pickupLocation;`${n.lat.toFixed(5)}${n.lng.toFixed(5)}${a.lat.toFixed(5)}${a.lng.toFixed(5)}`;let s=!1;return(async()=>{var F,m;try{const y=`https://router.project-osrm.org/route/v1/driving/${n.lng},${n.lat};${a.lng},${a.lat}?overview=full&geometries=geojson`,E=await fetch(y);if(!E.ok)throw new Error("osrm_failed");const g=await E.json(),L=(Array.isArray(g==null?void 0:g.routes)&&((m=(F=g.routes[0])==null?void 0:F.geometry)!=null&&m.coordinates)?g.routes[0].geometry.coordinates:[]).map(M=>({lat:M[1],lng:M[0]}));if(s)return;k(L.length>1?L:[n,a])}catch{if(s)return;k([n,a])}})(),()=>{s=!0}},[t==null?void 0:t.id,t==null?void 0:t.status,n==null?void 0:n.lat,n==null?void 0:n.lng,o==null?void 0:o.lat,o==null?void 0:o.lng]),i.useEffect(()=>{t!=null&&t.driverId&&(n||fetch(`/api/drivers/${t.driverId}`).then(e=>e.json()).then(e=>{var a;e!=null&&e.success&&((a=e==null?void 0:e.data)!=null&&a.location)&&x(e.data.location)}).catch(()=>{}))},[t==null?void 0:t.driverId,n]),i.useEffect(()=>{if(!c||!navigator.geolocation)return;const e=navigator.geolocation.watchPosition(a=>{const s={lat:a.coords.latitude,lng:a.coords.longitude};$(s);const d=Date.now();d-z.current<1500||(z.current=d,fetch(`/api/bookings/${c}/customer-location`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:s})}).catch(()=>{}))},()=>{},{enableHighAccuracy:!0,timeout:15e3,maximumAge:0});return()=>{try{navigator.geolocation.clearWatch(e)}catch{}}},[c]),i.useEffect(()=>{t&&T.current!==t.status&&(T.current=t.status,t.status==="pending"&&l.info("Sürücü kabulü bekleniyor."),t.status==="accepted"&&l.success("Sürücü çağrıyı kabul etti."),t.status==="driver_en_route"&&l.success("Sürücü yola çıktı."),t.status==="driver_arrived"&&l.success("Sürücü alış noktasına ulaştı."),t.status==="in_progress"&&l.info("Yolculuk başladı."),t.status==="completed"&&l.success("Yolculuk tamamlandı."),t.status==="cancelled"&&l.error("Yolculuk iptal edildi."))},[t==null?void 0:t.status]),i.useEffect(()=>{if(!t||!n||!o)return;I(n,o)<=50?A.current||(A.current=!0,l.success("Sürücü ile aynı konumdasınız.")):A.current=!1},[n,o,t==null?void 0:t.id]);const R=e=>e==="pending"?"Sürücü bekleniyor":e==="accepted"?"Sürücü kabul etti":e==="driver_en_route"?"Sürücü yolda":e==="driver_arrived"?"Sürücü geldi":e==="in_progress"?"Yolculuk devam ediyor":e==="completed"?"Yolculuk tamamlandı":e==="cancelled"?"İptal edildi":e,D=i.useMemo(()=>{if(!t||!n)return null;const e=t.status==="in_progress"?t.dropoffLocation:t.pickupLocation,a=I(n,e)/1e3;return Math.max(1,Math.round(a/35*60))},[t==null?void 0:t.status,t==null?void 0:t.pickupLocation,t==null?void 0:t.dropoffLocation,n]);if(!c)return r.jsx("div",{"trae-inspector-start-line":"177","trae-inspector-start-column":"6","trae-inspector-end-line":"181","trae-inspector-end-column":"12","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"min-h-screen bg-gray-50 py-8",children:r.jsx("div",{"trae-inspector-start-line":"178","trae-inspector-start-column":"8","trae-inspector-end-line":"180","trae-inspector-end-column":"14","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"max-w-3xl mx-auto px-4",children:r.jsx("div",{"trae-inspector-start-line":"179","trae-inspector-start-column":"10","trae-inspector-end-line":"179","trae-inspector-end-column":"82","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22text%22%3A%22Ge%C3%A7ersiz%20yolculuk.%22%2C%22textStartLine%22%3A%22179%22%2C%22textStartColumn%22%3A%2258%22%2C%22textEndLine%22%3A%22179%22%2C%22textEndColumn%22%3A%2276%22%2C%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"bg-white rounded-lg shadow p-6",children:"Geçersiz yolculuk."})})});if(!t)return r.jsx("div",{"trae-inspector-start-line":"187","trae-inspector-start-column":"6","trae-inspector-end-line":"197","trae-inspector-end-column":"12","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"min-h-screen bg-gray-50 py-8",children:r.jsx("div",{"trae-inspector-start-line":"188","trae-inspector-start-column":"8","trae-inspector-end-line":"196","trae-inspector-end-column":"14","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"max-w-3xl mx-auto px-4",children:r.jsxs("div",{"trae-inspector-start-line":"189","trae-inspector-start-column":"10","trae-inspector-end-line":"195","trae-inspector-end-column":"16","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"bg-white rounded-lg shadow p-6 flex items-center gap-3",children:[r.jsx(W,{className:"h-6 w-6 text-gray-400"}),r.jsxs("div",{"trae-inspector-start-line":"191","trae-inspector-start-column":"12","trae-inspector-end-line":"194","trae-inspector-end-column":"18","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",children:[r.jsx("div",{"trae-inspector-start-line":"192","trae-inspector-start-column":"14","trae-inspector-end-line":"192","trae-inspector-end-column":"73","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22text%22%3A%22Yolculuk%20y%C3%BCkleniyor...%22%2C%22textStartLine%22%3A%22192%22%2C%22textStartColumn%22%3A%2245%22%2C%22textEndLine%22%3A%22192%22%2C%22textEndColumn%22%3A%2267%22%2C%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"font-semibold",children:"Yolculuk yükleniyor..."}),r.jsx("div",{"trae-inspector-start-line":"193","trae-inspector-start-column":"14","trae-inspector-end-line":"193","trae-inspector-end-column":"90","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22text%22%3A%22Rezervasyon%20bilgileri%20al%C4%B1n%C4%B1yor.%22%2C%22textStartLine%22%3A%22193%22%2C%22textStartColumn%22%3A%2253%22%2C%22textEndLine%22%3A%22193%22%2C%22textEndColumn%22%3A%2284%22%2C%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"text-sm text-gray-600",children:"Rezervasyon bilgileri alınıyor."})]})]})})});const _=o||t.pickupLocation,Y=t.driverId&&n?[{id:t.driverId,name:"Sürücü",location:n,rating:0,available:!1}]:[],O=t.status==="in_progress"?v.length>1?v:void 0:w.length>1?w:void 0;return r.jsx("div",{"trae-inspector-start-line":"215","trae-inspector-start-column":"4","trae-inspector-end-line":"296","trae-inspector-end-column":"10","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"min-h-screen bg-gray-50 py-8",children:r.jsxs("div",{"trae-inspector-start-line":"216","trae-inspector-start-column":"6","trae-inspector-end-line":"295","trae-inspector-end-column":"12","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[r.jsxs("div",{"trae-inspector-start-line":"217","trae-inspector-start-column":"8","trae-inspector-end-line":"220","trae-inspector-end-column":"14","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"mb-6",children:[r.jsx("h1",{"trae-inspector-start-line":"218","trae-inspector-start-column":"10","trae-inspector-end-line":"218","trae-inspector-end-column":"75","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22text%22%3A%22Canl%C4%B1%20Takip%22%2C%22textStartLine%22%3A%22218%22%2C%22textStartColumn%22%3A%2259%22%2C%22textEndLine%22%3A%22218%22%2C%22textEndColumn%22%3A%2270%22%2C%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"text-2xl font-bold text-gray-900",children:"Canlı Takip"}),r.jsxs("p",{"trae-inspector-start-line":"219","trae-inspector-start-column":"10","trae-inspector-end-line":"219","trae-inspector-end-column":"119","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"text-sm text-gray-600",children:[t.pickupLocation.address," → ",t.dropoffLocation.address]})]}),r.jsxs("div",{"trae-inspector-start-line":"222","trae-inspector-start-column":"8","trae-inspector-end-line":"294","trae-inspector-end-column":"14","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[r.jsx("div",{"trae-inspector-start-line":"223","trae-inspector-start-column":"10","trae-inspector-end-line":"234","trae-inspector-end-column":"16","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"lg:col-span-2 bg-white rounded-lg shadow overflow-hidden",children:r.jsx("div",{"trae-inspector-start-line":"224","trae-inspector-start-column":"12","trae-inspector-end-line":"233","trae-inspector-end-column":"18","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"h-[520px]",children:r.jsx(H,{center:_,customerLocation:o||t.pickupLocation,destination:t.dropoffLocation,drivers:Y,highlightDriverId:t.driverId,path:O})})}),r.jsxs("div",{"trae-inspector-start-line":"236","trae-inspector-start-column":"10","trae-inspector-end-line":"293","trae-inspector-end-column":"16","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"space-y-4",children:[r.jsxs("div",{"trae-inspector-start-line":"237","trae-inspector-start-column":"12","trae-inspector-end-line":"261","trae-inspector-end-column":"18","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"bg-white rounded-lg shadow p-5",children:[r.jsxs("div",{"trae-inspector-start-line":"238","trae-inspector-start-column":"14","trae-inspector-end-line":"244","trae-inspector-end-column":"20","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"flex items-center justify-between",children:[r.jsxs("div",{"trae-inspector-start-line":"239","trae-inspector-start-column":"16","trae-inspector-end-line":"242","trae-inspector-end-column":"22","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"flex items-center gap-2",children:[r.jsx(Q,{className:"h-5 w-5 text-blue-600"}),r.jsx("div",{"trae-inspector-start-line":"241","trae-inspector-start-column":"18","trae-inspector-end-line":"241","trae-inspector-end-column":"60","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22text%22%3A%22Durum%22%2C%22textStartLine%22%3A%22241%22%2C%22textStartColumn%22%3A%2249%22%2C%22textEndLine%22%3A%22241%22%2C%22textEndColumn%22%3A%2254%22%2C%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"font-semibold",children:"Durum"})]}),r.jsx("div",{"trae-inspector-start-line":"243","trae-inspector-start-column":"16","trae-inspector-end-line":"243","trae-inspector-end-column":"125","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"text-sm px-3 py-1 rounded-full bg-gray-100 text-gray-800",children:R(t.status)})]}),r.jsx("div",{"trae-inspector-start-line":"245","trae-inspector-start-column":"14","trae-inspector-end-line":"247","trae-inspector-end-column":"20","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"mt-3 text-sm text-gray-700",children:D?`Tahmini süre: ${D} dk`:"Tahmini süre hesaplanıyor"}),r.jsx("div",{"trae-inspector-start-line":"248","trae-inspector-start-column":"14","trae-inspector-end-line":"257","trae-inspector-end-column":"20","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"mt-2 text-sm text-gray-700",children:(()=>{var m,y;const e=((y=(m=t==null?void 0:t.extras)==null?void 0:m.pricing)==null?void 0:y.currency)||"EUR",a=U(e),s=Number(t.basePrice||0),d=Number(t.finalPrice??t.basePrice??0),F=Math.max(0,d-s);return`Toplam: ${a}${d.toFixed(2)} • Şoför: ${a}${s.toFixed(2)} • Servis payı: ${a}${F.toFixed(2)}`})()}),!t.driverId&&r.jsx("div",{"trae-inspector-start-line":"259","trae-inspector-start-column":"16","trae-inspector-end-line":"259","trae-inspector-end-column":"91","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22text%22%3A%22S%C3%BCr%C3%BCc%C3%BC%20kabul%C3%BC%20bekleniyor.%22%2C%22textStartLine%22%3A%22259%22%2C%22textStartColumn%22%3A%2260%22%2C%22textEndLine%22%3A%22259%22%2C%22textEndColumn%22%3A%2285%22%2C%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"mt-3 text-sm text-gray-600",children:"Sürücü kabulü bekleniyor."})]}),r.jsxs("div",{"trae-inspector-start-line":"263","trae-inspector-start-column":"12","trae-inspector-end-line":"292","trae-inspector-end-column":"18","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"bg-white rounded-lg shadow p-5",children:[r.jsx("div",{"trae-inspector-start-line":"264","trae-inspector-start-column":"14","trae-inspector-end-line":"264","trae-inspector-end-column":"73","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22text%22%3A%22%C4%B0%C5%9Flemler%22%2C%22textStartLine%22%3A%22264%22%2C%22textStartColumn%22%3A%2259%22%2C%22textEndLine%22%3A%22264%22%2C%22textEndColumn%22%3A%2267%22%2C%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"font-semibold text-gray-900",children:"İşlemler"}),r.jsxs("div",{"trae-inspector-start-line":"265","trae-inspector-start-column":"14","trae-inspector-end-line":"291","trae-inspector-end-column":"20","trae-inspector-file-path":"src/pages/TrackingPage.tsx","trae-inspector-static-props":"%7B%22cwd%22%3A%22%2Fhome%2Fz%2Fmy-project%2Fgettransfer%22%7D",className:"mt-3 flex gap-2",children:[r.jsx(b,{variant:"outline",disabled:P||t.status==="completed"||t.status==="cancelled",onClick:async()=>{if(confirm("Yolculuğu iptal etmek istiyor musunuz?")){B(!0);try{await C(t.id,"cancelled"),p("/customer/dashboard")}catch{l.error("İptal başarısız")}finally{B(!1)}}},children:"İptal Et"}),r.jsx(b,{variant:"outline",disabled:P,onClick:()=>p("/customer/dashboard"),children:"Panele Dön"})]})]})]})]})]})})};export{st as TrackingPage};
